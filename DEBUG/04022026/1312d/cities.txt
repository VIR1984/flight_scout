# utils/cities.py
import re
from typing import Dict, Tuple, List

CITY_TO_IATA = { # üá∑üá∫ –†–æ—Å—Å–∏—è
    "–º–æ—Å–∫–≤–∞": "MOW",
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": "LED",
    "–∫–∞–∑–∞–Ω—å": "KZN",
    "—Å–æ—á–∏": "AER",
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": "SVX",
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": "OVB",
    "–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫": "VVO",
    "–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥": "KGD",
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä": "KRR",
    "–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –≤–æ–¥—ã": "MRV",
    "–º–∞—Ö–∞—á–∫–∞–ª–∞": "MCX",
    "—Å–∞–º–∞—Ä–∞": "KUF",
    "—É—Ñ–∞": "UFA",
    "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É": "ROV",
    "–∏—Ä–∫—É—Ç—Å–∫": "IKT",
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": "KJA",
    "—Ö–∞–±–∞—Ä–æ–≤—Å–∫": "KHV",
    "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥": "GOJ",
    "—á–µ–ª—è–±–∏–Ω—Å–∫": "CEK",
    "–ø–µ—Ä–º—å": "PEE",
    "–æ–º—Å–∫": "OMS",
    "–≤–æ–ª–≥–æ–≥—Ä–∞–¥": "VOG",
    "—Å–∞—Ä–∞—Ç–æ–≤": "GWW",
    "—Ç—é–º–µ–Ω—å": "TJM",
    "–±–∞—Ä–Ω–∞—É–ª": "BAX",
    "—Ç–æ–º—Å–∫": "TOF",
    "–∫–µ–º–µ—Ä–æ–≤–æ": "KEJ",
    "–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫": "ARH",
    "–º—É—Ä–º–∞–Ω—Å–∫": "MMK",
    "—Å–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å": "SIP",
    "–∞—Å—Ç—Ä–∞—Ö–∞–Ω—å": "ASF",
    "–±–µ–ª–≥–æ—Ä–æ–¥": "EGO",
    "–≤–æ–ª–æ–≥–¥–∞": "VGD",
    "–∏–≤–∞–Ω–æ–≤–æ": "IWA",
    "–π–æ—à–∫–∞—Ä-–æ–ª–∞": "JOK",
    "–∫–∏—Ä–æ–≤": "KVX",
    "–º–∞–≥–∞–¥–∞–Ω": "GDX",
    "–Ω–∏–∂–Ω–µ–≤–∞—Ä—Ç–æ–≤—Å–∫": "NJC",
    "–Ω–æ–≤—ã–π —É—Ä–µ–Ω–≥–æ–π": "NUX",
    "–Ω–æ—è–±—Ä—å—Å–∫": "NOJ",
    "–æ—Ä–µ–Ω–±—É—Ä–≥": "REN",
    "–ø–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫": "PES",
    "—Å—É—Ä–≥—É—Ç": "SGC",
    "—Å—ã–∫—Ç—ã–≤–∫–∞—Ä": "SCW",
    "—Ç–∞–º–±–æ–≤": "TBW",
    "—á–µ—Ä–µ–ø–æ–≤–µ—Ü": "CEP",
    "–∞–Ω–∞–ø–∞": "AAQ",
    "–≥–µ–ª–µ–Ω–¥–∂–∏–∫": "GDZ",
    "–≥—Ä–æ–∑–Ω—ã–π": "GRV",
    "–∫—É—Ä—Å–∫": "URS",
    "—É–ª—å—è–Ω–æ–≤—Å–∫": "ULY",
    "—á–µ–±–æ–∫—Å–∞—Ä—ã": "CSY",
    "—é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫": "UUS",
    "–∞–±–∞–∫–∞–Ω": "ABA",
    "–±–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫": "BQS",
    "–≥–æ—Ä–Ω–æ-–∞–ª—Ç–∞–π—Å–∫": "RGK",
    "–∫–æ–≥–∞–ª—ã–º": "KGP",
    "–∫—É—Ä–≥–∞–Ω": "KRO",
    "–º–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫": "MQF",
    "–º–∏—Ä–Ω—ã–π": "MJZ",
    "–Ω–∞–¥—ã–º": "NYM",
    "–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫": "NOZ",
    "–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–∫–∞–º—á–∞—Ç—Å–∫–∏–π": "PKC",
    "—Å–∞—Ä–∞–Ω—Å–∫": "SKX",
    "—Ö–∞–Ω—Ç—ã-–º–∞–Ω—Å–∏–π—Å–∫": "HMA",
    "—á–∏—Ç–∞": "HTA",
    "—ç–ª–∏—Å—Ç–∞": "ESL",
    "—è–∫—É—Ç—Å–∫": "YKS",
    "–∏–∂–µ–≤—Å–∫": "IJK",
    "–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫-–Ω–∞-–∞–º—É—Ä–µ": "KXK",
    "–Ω–∞—Ä—å—è–Ω-–º–∞—Ä": "NNM",
    "–Ω–µ—Ä—é–Ω–≥—Ä–∏": "NER",
    "–Ω–æ—Ä–∏–ª—å—Å–∫": "NSK",
    "—Ä—è–∑–∞–Ω—å": "RZN",
    "—Å—Ç–∞–≤—Ä–æ–ø–æ–ª—å": "STW",
    "—É—Å—Ç—å-–∏–ª–∏–º—Å–∫": "UIK",
    "—É—Å—Ç—å-–∫—É—Ç": "UKX",
    "—è—Ä–æ—Å–ª–∞–≤–ª—å": "IAR",
    "–æ—Ä—Å–∫": "OSW",
    # üåç –°–ù–ì –∏ –±–ª–∏–∂–Ω–µ–µ –∑–∞—Ä—É–±–µ–∂—å–µ
    "–∞–ª–º–∞—Ç—ã": "ALA",
    "–∞—Å—Ç–∞–Ω–∞": "NQZ",
    "–±–∞–∫—É": "BAK",
    "—Ç–±–∏–ª–∏—Å–∏": "TBS",
    "–µ—Ä–µ–≤–∞–Ω": "EVN",
    "–∫–∏—à–∏–Ω—ë–≤": "KIV",
    "—Ç–∞—à–∫–µ–Ω—Ç": "TAS",
    "–±–∏—à–∫–µ–∫": "FRU",
    "–¥—É—à–∞–Ω–±–µ": "DYU",
    "–∞—à—Ö–∞–±–∞–¥": "ASB",
    "–º–∏–Ω—Å–∫": "MSQ",
    # üåé –ï–≤—Ä–æ–ø–∞
    "–ª–æ–Ω–¥–æ–Ω": "LON",
    "–ø–∞—Ä–∏–∂": "PAR",
    "–±–µ—Ä–ª–∏–Ω": "BER",
    "—Ä–∏–º": "ROM",
    "–º–∏–ª–∞–Ω": "MIL",
    "–º–∞–¥—Ä–∏–¥": "MAD",
    "–±–∞—Ä—Å–µ–ª–æ–Ω–∞": "BCN",
    "–∞–º—Å—Ç–µ—Ä–¥–∞–º": "AMS",
    "–±—Ä—é—Å—Å–µ–ª—å": "BRU",
    "–≤–µ–Ω–∞": "VIE",
    "–ø—Ä–∞–≥–∞": "PRG",
    "–≤–∞—Ä—à–∞–≤–∞": "WAW",
    "–±—É–¥–∞–ø–µ—à—Ç": "BUD",
    "—Å—Ç–æ–∫–≥–æ–ª—å–º": "STO",
    "–æ—Å–ª–æ": "OSL",
    "–∫–æ–ø–µ–Ω–≥–∞–≥–µ–Ω": "CPH",
    "—Ü—é—Ä–∏—Ö": "ZRH",
    "–∂–µ–Ω–µ–≤–∞": "GVA",
    "–∞—Ñ–∏–Ω—ã": "ATH",
    "—Å—Ç–∞–º–±—É–ª": "IST",
    # üåè –ê–∑–∏—è –∏ –ë–ª–∏–∂–Ω–∏–π –í–æ—Å—Ç–æ–∫
    "–¥—É–±–∞–π": "DXB",
    "–∞–±—É-–¥–∞–±–∏": "AUH",
    "–¥–æ—Ö–∞": "DOH",
    "—ç—Ä-—Ä–∏—è–¥": "RUH",
    "–¥–∂–∏–¥–¥–∞": "JED",
    "—Ç–µ–ª—å-–∞–≤–∏–≤": "TLV",
    "–±–∞–Ω–≥–∫–æ–∫": "BKK",
    "–ø—Ö—É–∫–µ—Ç": "HKT",
    "—Å–∏–Ω–≥–∞–ø—É—Ä": "SIN",
    "–∫—É–∞–ª–∞-–ª—É–º–ø—É—Ä": "KUL",
    "—Ö–æ—à–∏–º–∏–Ω": "SGN",
    "—Ö–∞–Ω–æ–π": "HAN",
    "—Å–µ—É–ª": "SEL",
    "—Ç–æ–∫–∏–æ": "TYO",
    "–æ—Å–∞–∫–∞": "OSA",
    "–ø–µ–∫–∏–Ω": "BJS",
    "—à–∞–Ω—Ö–∞–π": "SHA",
    "–≥–æ–Ω–∫–æ–Ω–≥": "HKG",
    "–¥–µ–ª–∏": "DEL",
    "–º—É–º–±–∞–∏": "BOM",
    # üá∫üá∏ –ê–º–µ—Ä–∏–∫–∞
    "–Ω—å—é-–π–æ—Ä–∫": "NYC",
    "–ª–æ—Å-–∞–Ω–¥–∂–µ–ª–µ—Å": "LAX",
    "—Å–∞–Ω-—Ñ—Ä–∞–Ω—Ü–∏—Å–∫–æ": "SFO",
    "—á–∏–∫–∞–≥–æ": "CHI",
    "–≤–∞—à–∏–Ω–≥—Ç–æ–Ω": "WAS",
    "–º–∞–π–∞–º–∏": "MIA",
    "–±–æ—Å—Ç–æ–Ω": "BOS",
    "–∞—Ç–ª–∞–Ω—Ç–∞": "ATL",
    "—Ç–æ—Ä–æ–Ω—Ç–æ": "YTO",
    "–≤–∞–Ω–∫—É–≤–µ—Ä": "YVR",
    "–º–µ—Ö–∏–∫–æ": "MEX",
    "—Å–∞–Ω-–ø–∞—É–ª—É": "SAO",
    "—Ä–∏–æ-–¥–µ-–∂–∞–Ω–µ–π—Ä–æ": "RIO",
    "–±—É—ç–Ω–æ—Å-–∞–π—Ä–µ—Å": "BUE",
    # üåê –ê–≤—Å—Ç—Ä–∞–ª–∏—è
    "—Å–∏–¥–Ω–µ–π": "SYD",
    "–º–µ–ª—å–±—É—Ä–Ω": "MEL",
    "–±—Ä–∏—Å–±–µ–Ω": "BNE"
}

GLOBAL_HUBS = ["MOW", "LED", "IST", "LON", "PAR", "NYC", "DXB", "BKK", "SIN", "FRA"]
IATA_TO_CITY = {v: k.capitalize() for k, v in CITY_TO_IATA.items()}

def levenshtein_distance(s1: str, s2: str) -> int:
    """–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø–µ—á–∞—Ç–æ–∫"""
    if len(s1) < len(s2):
        return levenshtein_distance(s2, s1)
    if len(s2) == 0:
        return len(s1)
    previous_row = range(len(s2) + 1)
    for i, c1 in enumerate(s1):
        current_row = [i + 1]
        for j, c2 in enumerate(s2):
            insertions = previous_row[j + 1] + 1
            deletions = current_row[j] + 1
            substitutions = previous_row[j] + (c1 != c2)
            current_row.append(min(insertions, deletions, substitutions))
        previous_row = current_row
    return previous_row[-1]

def find_similar_city(user_input: str, threshold: int = 2) -> Tuple[bool, str]:
    """
    –ò—â–µ—Ç –ø–æ—Ö–æ–∂–∏–π –≥–æ—Ä–æ–¥ —Å —É—á—ë—Ç–æ–º –æ–ø–µ—á–∞—Ç–æ–∫.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–Ω–∞–π–¥–µ–Ω_–ª–∏, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ)
    """
    user_input = user_input.strip().lower()
    if user_input in CITY_TO_IATA:
        return True, user_input
    
    # –ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞
    best_match = None
    best_dist = threshold + 1
    
    for city in CITY_TO_IATA.keys():
        dist = levenshtein_distance(user_input, city)
        if dist < best_dist:
            best_dist = dist
            best_match = city
    
    if best_match and best_dist <= threshold:
        return True, best_match
    
    return False, user_input

def smart_parse_route(text: str) -> Dict:
    """
    –£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫:
    - –°–ª–∏—Ç–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤
    - –û–ø–µ—á–∞—Ç–∫–∏
    - –†–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (-, ‚Üí, >, –ø—Ä–æ–±–µ–ª—ã)
    - –ó–∞–ø—è—Ç—ã–µ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
    """
    result = {
        "success": False,
        "error": "",
        "origin": "",
        "dest": "",
        "depart_date": None,
        "return_date": None,
        "passengers": "",
        "is_cheap_search": False
    }
    
    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã, —Ç–æ—á–∫–∏, –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r"[^\w\s\-\.\,]", " ", text.lower())
    text = re.sub(r"\s+", " ", text).strip()
    
    # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏
    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º: "-", " - ", "‚Üí", ">", —Å–ª–∏—Ç–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ (–ø–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –≥–æ—Ä–æ–¥–∞–º)
    route_part = text
    passengers_part = ""
    
    # –û—Ç–¥–µ–ª—è–µ–º –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ (–≤—Å—ë –ø–æ—Å–ª–µ –¥–∞—Ç—ã –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ)
    passenger_match = re.search(r"(\d+\s*(?:–≤–∑—Ä|—Ä–µ–±|–º–ª|–¥–µ—Ç|–º–ª–∞–¥)[\w\s\.,]*)$", text)
    if passenger_match:
        passengers_part = passenger_match.group(1)
        route_part = text[:passenger_match.start()].strip()
    
    # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –¥–∞—Ç—ã
    date_matches = re.findall(r"\d{1,2}\.\d{1,2}", route_part)
    depart_date = date_matches[0] if len(date_matches) > 0 else None
    return_date = date_matches[1] if len(date_matches) > 1 else None
    
    # –£–¥–∞–ª—è–µ–º –¥–∞—Ç—ã –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
    route_clean = re.sub(r"\d{1,2}\.\d{1,2}", "", route_part)
    route_clean = re.sub(r"\s*-\s*-\s*", " - ", route_clean)  # –¥–≤–æ–π–Ω–æ–π –¥–µ—Ñ–∏—Å ‚Üí –æ–¥–∏–Ω–∞—Ä–Ω—ã–π
    route_clean = re.sub(r"\s+", " ", route_clean).strip()
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—é
    parts = re.split(r"\s*[-‚Üí>]\s*", route_clean)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è ‚Äî –ø—Ä–æ–±—É–µ–º —Å–ª–∏—Ç–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ
    if len(parts) < 2:
        # –ò—â–µ–º –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
        found_origin = None
        for city in sorted(CITY_TO_IATA.keys(), key=len, reverse=True):
            if route_clean.startswith(city.replace(" ", "")):
                found_origin = city
                break
        
        if found_origin:
            # –û—Å—Ç–∞—Ç–æ–∫ ‚Äî –≥–æ—Ä–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            dest_part = route_clean[len(found_origin.replace(" ", "")):].strip()
            # –ò—â–µ–º –≥–æ—Ä–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            found_dest = None
            for city in sorted(CITY_TO_IATA.keys(), key=len, reverse=True):
                if dest_part.startswith(city.replace(" ", "")):
                    found_dest = city
                    break
            
            if found_dest:
                parts = [found_origin, found_dest]
            else:
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–π –≥–æ—Ä–æ–¥
                success, corrected = find_similar_city(dest_part)
                if success:
                    parts = [found_origin, corrected]
                else:
                    result["error"] = (
                        f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥ –ø—Ä–∏–±—ã—Ç–∏—è: <b>{dest_part}</b>\n"
                        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å: <code>–ú–æ—Å–∫–≤–∞ - –°–æ—á–∏</code>"
                    )
                    return result
        else:
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–π –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            success, corrected = find_similar_city(route_clean.split()[0] if route_clean.split() else "")
            if success:
                result["error"] = (
                    f"‚ùå –í–æ–∑–º–æ–∂–Ω–æ –æ–ø–µ—á–∞—Ç–∫–∞ –≤ –≥–æ—Ä–æ–¥–µ: <b>{route_clean.split()[0]}</b>\n"
                    f"–ú–æ–∂–µ—Ç –±—ã—Ç—å, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: <b>{corrected}</b>?\n"
                    "–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: <code>–ú–æ—Å–∫–≤–∞ - –°–æ—á–∏ 10.03</code>"
                )
            else:
                result["error"] = (
                    "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç.\n"
                    "üí° –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:\n"
                    "<code>–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ - –ì–æ—Ä–æ–¥ –ø—Ä–∏–ª—ë—Ç–∞ –î–î.–ú–ú</code>\n"
                    "–ü—Ä–∏–º–µ—Ä: <code>–ú–æ—Å–∫–≤–∞ - –°–æ—á–∏ 10.03</code>"
                )
            return result
    
    if len(parts) < 2:
        result["error"] = (
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞.\n"
            "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ñ–∏—Å –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏:\n"
            "<code>–ú–æ—Å–∫–≤–∞ - –°–æ—á–∏ 10.03</code>"
        )
        return result
    
    origin_raw = parts[0].strip()
    dest_raw = parts[1].strip().split()[0] if parts[1].strip() else ""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    if origin_raw == "–≤–µ–∑–¥–µ":
        origin = "–≤–µ–∑–¥–µ"
    else:
        success, corrected = find_similar_city(origin_raw)
        if not success:
            result["error"] = (
                f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: <b>{origin_raw}</b>\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥."
            )
            return result
        origin = corrected
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏–±—ã—Ç–∏—è
    success, corrected = find_similar_city(dest_raw)
    if not success:
        result["error"] = (
            f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥ –ø—Ä–∏–±—ã—Ç–∏—è: <b>{dest_raw}</b>\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥."
        )
        return result
    dest = corrected
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞
    is_cheap_search = depart_date is None
    
    result.update({
        "success": True,
        "origin": origin,
        "dest": dest,
        "depart_date": depart_date,
        "return_date": return_date,
        "passengers": passengers_part,
        "is_cheap_search": is_cheap_search
    })
    
    return result