# services/price_watcher.py
import asyncio
import json
import time
from typing import Dict, Optional
from aiogram import Bot
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from services.flight_search import search_flights, generate_booking_link, normalize_date
from utils.redis_client import redis_client
from utils.logger import logger

class PriceWatcher:
    """–§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–∞–¥–µ–Ω–∏—è —Ü–µ–Ω"""
    
    def __init__(self, bot: Bot):
        self.bot = bot
        self.running = False
        self.check_interval = 21600  # 6 —á–∞—Å–æ–≤
    
    async def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"""
        self.running = True
        logger.info("üîÑ –ó–∞–ø—É—Å–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è –∑–∞ —Ü–µ–Ω–∞–º–∏...")
        
        while self.running:
            try:
                await self.check_all_watches()
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ü–µ–Ω: {e}")
            
            await asyncio.sleep(self.check_interval)
    
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è"""
        self.running = False
        logger.info("‚èπÔ∏è –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Ü–µ–Ω–∞–º–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    async def check_all_watches(self):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"""
        watch_keys = await redis_client.get_all_watch_keys()
        
        if not watch_keys:
            logger.info("üîç –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–π")
            return
        
        logger.info(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ {len(watch_keys)} –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–π...")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —á–∞—Å—Ç—è–º, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å API
        chunk_size = 5
        for i in range(0, len(watch_keys), chunk_size):
            chunk = watch_keys[i:i + chunk_size]
            
            for key in chunk:
                try:
                    watch_data = json.loads(await redis_client.client.get(key))
                    await self.check_single_watch(watch_data, key)
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ {key}: {e}")
            
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
            if i + chunk_size < len(watch_keys):
                await asyncio.sleep(5)
    
    async def check_single_watch(self, watch: Dict, key: str):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ"""
        current_price = watch["current_price"]
        user_id = watch["user_id"]
        
        # –ò—â–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
        flights = await search_flights(
            origin=watch["origin"],
            dest=watch["dest"],
            depart_date=normalize_date(watch["depart_date"]),
            return_date=normalize_date(watch["return_date"]) if watch["return_date"] else None
        )
        
        if not flights:
            return
        
        # –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
        new_min_flight = min(flights, key=lambda f: f.get("value") or f.get("price") or 999999)
        new_price = new_min_flight.get("value") or new_min_flight.get("price") or current_price
        
        # –ï—Å–ª–∏ —Ü–µ–Ω–∞ —É–ø–∞–ª–∞ - —É–≤–µ–¥–æ–º–ª—è–µ–º
        if new_price < current_price:
            price_drop = current_price - new_price
            percent_drop = (price_drop / current_price) * 100
            
            logger.info(
                f"üìâ –¶–µ–Ω–∞ —É–ø–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: "
                f"{current_price} ‚ÇΩ ‚Üí {new_price} ‚ÇΩ (-{price_drop} ‚ÇΩ, -{percent_drop:.1f}%)"
            )
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é —Å—Å—ã–ª–∫—É
            booking_link = generate_booking_link(
                flight=new_min_flight,
                origin=watch["origin"],
                dest=watch["dest"],
                depart_date=watch["depart_date"],
                passengers_code=watch.get("passengers", "1"),
                return_date=watch["return_date"]
            )
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            origin_name = watch["origin"]
            dest_name = watch["dest"]
            
            message = (
                f"üéâ <b>–¶–µ–Ω–∞ —É–ø–∞–ª–∞!</b>\n\n"
                f"üìç –ú–∞—Ä—à—Ä—É—Ç: {origin_name} ‚Üí {dest_name}\n"
                f"üìÖ –í—ã–ª–µ—Ç: {watch['depart_date']}\n"
            )
            
            if watch["return_date"]:
                message += f"üìÖ –í–æ–∑–≤—Ä–∞—Ç: {watch['return_date']}\n"
            
            message += (
                f"\nüí∞ <b>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞:</b> {current_price} ‚ÇΩ\n"
                f"üí∞ <b>–ù–æ–≤–∞—è —Ü–µ–Ω–∞:</b> {new_price} ‚ÇΩ\n"
                f"üí∏ <b>–≠–∫–æ–Ω–æ–º–∏—è:</b> {price_drop} ‚ÇΩ ({percent_drop:.1f}%)\n\n"
                f"üöÄ <b>–ë—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –±—ã—Å—Ç—Ä–æ, –ø–æ–∫–∞ —Ü–µ–Ω–∞ –Ω–µ –≤—ã—Ä–æ—Å–ª–∞!</b>"
            )
            
            # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text=f"‚úàÔ∏è –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ {new_price} ‚ÇΩ", url=booking_link)],
                [InlineKeyboardButton(text="‚ùå –ë–æ–ª—å—à–µ –Ω–µ —Å–ª–µ–¥–∏—Ç—å", 
                                     callback_data=f"unwatch_{key}")]
            ])
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            try:
                await self.bot.send_message(
                    chat_id=user_id,
                    text=message,
                    parse_mode="HTML",
                    reply_markup=keyboard
                )
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ü–µ–Ω—É
                watch["current_price"] = new_price
                await redis_client.client.setex(
                    key, 
                    86400 * 30, 
                    json.dumps(watch, ensure_ascii=False)
                )
                
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                
            except Exception as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")